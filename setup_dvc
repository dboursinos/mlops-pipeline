#!/bin/bash

# Load environment variables from .env file
if [ -f .env ]; then
  export $(grep -v '^#' .env | xargs -d '\n' printf "%s\n" | sed -E 's/(export +)?([^=]+)=(.*)/export \2=\3/g')
fi

# Check if required environment variables are set
if [ -z "$MINIO_ENDPOINT" ] || [ -z "$MINIO_BUCKET" ] || [ -z "$MINIO_REGION" ] || [ -z "$MINIO_ACCESS_KEY" ] || [ -z "$MINIO_SECRET_KEY" ]; then
  echo "Error: Missing required environment variables. Please define MINIO_ENDPOINT, MINIO_BUCKET, MINIO_REGION, MINIO_ACCESS_KEY, and MINIO_SECRET_KEY in .env."
  exit 1
fi

dvc init

# Configure DVC remote for MinIO
echo "Configuring DVC remote 'minio'..."

dvc remote add -d minio "s3://${MINIO_BUCKET}" --local
if [ $? -ne 0 ]; then
  echo "Error: Failed to add DVC remote."
  exit 1
fi

dvc remote modify minio endpointurl "${MINIO_ENDPOINT}" --local
if [ $? -ne 0 ]; then
  echo "Error: Failed to modify endpointurl."
  exit 1
fi

dvc remote modify minio region "${MINIO_REGION}" --local
if [ $? -ne 0 ]; then
  echo "Error: Failed to modify region."
  exit 1
fi

dvc remote modify minio access_key_id "${MINIO_ACCESS_KEY}" --local
if [ $? -ne 0 ]; then
  echo "Error: Failed to modify access_key_id."
  exit 1
fi

dvc remote modify minio secret_access_key "${MINIO_SECRET_KEY}" --local
if [ $? -ne 0 ]; then
  echo "Error: Failed to modify secret_access_key."
  exit 1
fi

echo "DVC remote 'minio' configured successfully."
